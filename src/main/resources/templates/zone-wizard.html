<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/base}">
<head>
    <title>Kreator strefy - Bezpieczna Rodzina</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Wizard Container -->
        <div class="max-w-4xl mx-auto" th:data-current-step="${currentStep}">
            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center" th:each="step, iterStat : ${wizardSteps}">
                            <div class="flex items-center">
                                <!-- Completed step -->
                                <div th:if="${iterStat.index < currentStep}" 
                                     class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-green-500 text-white">
                                    <span th:text="${iterStat.index + 1}">1</span>
                                </div>
                                <!-- Current step -->
                                <div th:if="${iterStat.index == currentStep}" 
                                     class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-blue-500 text-white">
                                    <span th:text="${iterStat.index + 1}">1</span>
                                </div>
                                <!-- Future step -->
                                <div th:if="${iterStat.index > currentStep}" 
                                     class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-gray-200 text-gray-500">
                                    <span th:text="${iterStat.index + 1}">1</span>
                                </div>
                                
                                <!-- Step title -->
                                <span th:if="${iterStat.index <= currentStep}" 
                                      class="ml-2 text-sm font-medium text-gray-900" 
                                      th:text="${step.title}">Krok</span>
                                <span th:if="${iterStat.index > currentStep}" 
                                      class="ml-2 text-sm font-medium text-gray-500" 
                                      th:text="${step.title}">Krok</span>
                            </div>
                            <div th:if="${!iterStat.last}" class="w-8 h-0.5 bg-gray-200 mx-2"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        Krok <span th:text="${currentStep + 1}">1</span> z <span th:text="${wizardSteps.size()}">4</span>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div th:style="'width: ' + ${(currentStep + 1) * 100 / wizardSteps.size()} + '%'"
                         class="bg-blue-500 h-2 rounded-full transition-all duration-300"></div>
                </div>
            </div>

            <!-- Wizard Content -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                <div class="p-8">
                    <!-- Step 1: Zone Name & Icon -->
                    <div th:if="${currentStep == 0}" class="space-y-6">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Nazwa i ikona strefy</h2>
                            <p class="text-gray-600">Wybierz nazwƒô i ikonƒô dla swojej strefy bezpiecze≈Ñstwa</p>
                        </div>
                        
                        <!-- Zone Name Input -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Nazwa strefy</label>
                            <input type="text" 
                                   id="zoneName" 
                                   placeholder="np. Dom, Szko≈Ça, Praca..."
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <!-- Icon Selection -->
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">Wybierz ikonƒô</label>
                            <div class="grid grid-cols-4 gap-4">
                                <div th:each="icon : ${availableIcons}" 
                                     class="icon-option cursor-pointer p-4 border-2 border-gray-200 rounded-lg text-center hover:border-blue-300 transition-colors duration-200"
                                     th:data-icon="${icon.name}"
                                     th:onclick="selectIcon('${icon.name}', '${icon.emoji}')">
                                    <div class="text-3xl mb-2" th:text="${icon.emoji}">üè†</div>
                                    <div class="text-sm text-gray-600" th:text="${icon.label}">Dom</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Location -->
                    <div th:if="${currentStep == 1}" class="space-y-6">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Lokalizacja strefy</h2>
                            <p class="text-gray-600">Wprowad≈∫ adres lub wybierz lokalizacjƒô na mapie</p>
                        </div>
                        
                        <!-- Address Input -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Adres</label>
                            <input type="text" 
                                   id="zoneAddress" 
                                   placeholder="np. ul. Przyk≈Çadowa 123, Warszawa"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <!-- Map Placeholder -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Mapa</label>
                            <div class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                                <div class="text-center">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <p class="text-gray-500">Mapa bƒôdzie dostƒôpna w nastƒôpnej fazie rozwoju</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Radius -->
                    <div th:if="${currentStep == 2}" class="space-y-6">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Promie≈Ñ strefy</h2>
                            <p class="text-gray-600">Ustaw promie≈Ñ strefy bezpiecze≈Ñstwa</p>
                        </div>
                        
                        <!-- Radius Slider -->
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="text-4xl font-bold text-blue-600 mb-2">
                                    <span id="radiusValue">500</span>m
                                </div>
                                <p class="text-gray-500">Promie≈Ñ strefy</p>
                            </div>
                            
                            <div class="px-4">
                                <input type="range" 
                                       id="radiusSlider" 
                                       min="100" 
                                       max="5000" 
                                       value="500" 
                                       step="50"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            
                            <!-- Quick Radius Buttons -->
                            <div class="flex justify-center space-x-2">
                                <button type="button" 
                                        onclick="setRadius(100)" 
                                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
                                    100m
                                </button>
                                <button type="button" 
                                        onclick="setRadius(500)" 
                                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
                                    500m
                                </button>
                                <button type="button" 
                                        onclick="setRadius(1000)" 
                                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
                                    1km
                                </button>
                                <button type="button" 
                                        onclick="setRadius(2000)" 
                                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
                                    2km
                                </button>
                            </div>
                        </div>
                        
                        <!-- Map Preview Placeholder -->
                        <div class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                            <div class="text-center">
                                <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <p class="text-gray-500 text-sm">PodglƒÖd mapy z okrƒôgiem promienia</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Notifications -->
                    <div th:if="${currentStep == 3}" class="space-y-6">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Powiadomienia</h2>
                            <p class="text-gray-600">Wybierz urzƒÖdzenia, kt√≥re bƒôdƒÖ otrzymywaƒá powiadomienia</p>
                        </div>
                        
                        <!-- Device List -->
                        <div class="space-y-4">
                            <div th:each="device : ${userDevices}" 
                                 class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-900" th:text="${device.name}">iPhone 13</h3>
                                        <p class="text-sm text-gray-500" th:text="${device.type}">Telefon</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" 
                                           th:value="${device.id}"
                                           class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Summary -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-medium text-gray-900 mb-2">Podsumowanie strefy</h3>
                            <div class="space-y-1 text-sm text-gray-600">
                                <div class="flex justify-between">
                                    <span>Nazwa:</span>
                                    <span id="summaryName" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Adres:</span>
                                    <span id="summaryAddress" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Promie≈Ñ:</span>
                                    <span id="summaryRadius" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Powiadomienia:</span>
                                    <span id="summaryNotifications" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wizard Navigation -->
                <div class="flex justify-between items-center p-6 bg-gray-50 rounded-b-xl">
                    <button type="button" 
                            th:if="${currentStep > 0}"
                            onclick="previousStep()" 
                            class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors duration-200">
                        ‚Üê Wstecz
                    </button>
                    <div th:unless="${currentStep > 0}" class="w-20"></div>
                    
                    <div class="flex space-x-3">
                        <button type="button" 
                                onclick="cancelWizard()" 
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors duration-200">
                            Anuluj
                        </button>
                        <button type="button" 
                                th:if="${currentStep < 3}"
                                onclick="nextStep()" 
                                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                            Dalej ‚Üí
                        </button>
                        <button type="button" 
                                th:if="${currentStep == 3}"
                                onclick="saveZone()" 
                                class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200">
                            Zapisz strefƒô
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Global variables
        let selectedIcon = null;
        let currentStep = /*[[${currentStep}]]*/ 0;
        let wizardData = {
            name: '',
            icon: '',
            address: '',
            radius: 500,
            devices: []
        };

        // Navigation functions - defined globally
        function nextStep() {
            console.log('nextStep() called, currentStep:', currentStep);
            if (validateCurrentStep()) {
                const nextStep = currentStep + 1;
                console.log('Moving to next step:', nextStep);
                if (nextStep < 4) {
                    window.location.href = `/zones/wizard?step=${nextStep}`;
                }
            } else {
                console.log('Validation failed');
            }
        }

        function previousStep() {
            console.log('previousStep() called, currentStep:', currentStep);
            const prevStep = currentStep - 1;
            if (prevStep >= 0) {
                console.log('Moving to previous step:', prevStep);
                window.location.href = `/zones/wizard?step=${prevStep}`;
            }
        }

        function cancelWizard() {
            console.log('cancelWizard() called');
            if (confirm('Czy na pewno chcesz anulowaƒá tworzenie strefy? Wszystkie wprowadzone dane zostanƒÖ utracone.')) {
                localStorage.removeItem('wizardData');
                window.location.href = '/zones';
            }
        }

        function selectIcon(iconName, iconEmoji) {
            console.log('selectIcon() called:', iconName, iconEmoji);
            // Remove previous selection
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('border-blue-500', 'bg-blue-50');
                option.classList.add('border-gray-200');
            });
            
            // Add selection to clicked option
            event.target.closest('.icon-option').classList.add('border-blue-500', 'bg-blue-50');
            event.target.closest('.icon-option').classList.remove('border-gray-200');
            
            selectedIcon = { name: iconName, emoji: iconEmoji };
            wizardData.icon = iconName;
            updateSummary();
            saveWizardData();
        }

        function setRadius(radius) {
            const slider = document.getElementById('radiusSlider');
            const value = document.getElementById('radiusValue');
            
            if (slider && value) {
                slider.value = radius;
                value.textContent = radius;
                wizardData.radius = radius;
                updateSummary();
            }
        }

        function saveZone() {
            console.log('saveZone() called');
            const formData = new FormData();
            
            const zoneName = document.getElementById('zoneName');
            if (zoneName && zoneName.value.trim()) {
                formData.append('name', zoneName.value.trim());
            } else {
                alert('Proszƒô wprowadziƒá nazwƒô strefy');
                return;
            }
            
            if (selectedIcon) {
                formData.append('icon', selectedIcon.name);
            } else {
                alert('Proszƒô wybraƒá ikonƒô strefy');
                return;
            }
            
            const zoneAddress = document.getElementById('zoneAddress');
            if (zoneAddress && zoneAddress.value.trim()) {
                formData.append('address', zoneAddress.value.trim());
            } else {
                alert('Proszƒô wprowadziƒá adres strefy');
                return;
            }
            
            const radiusSlider = document.getElementById('radiusSlider');
            if (radiusSlider) {
                formData.append('radius', radiusSlider.value);
            }
            
            const selectedDevices = document.querySelectorAll('input[type="checkbox"]:checked');
            selectedDevices.forEach(device => {
                formData.append('deviceIds', device.value);
            });
            
            fetch('/zones', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    localStorage.removeItem('wizardData');
                    window.location.href = response.url;
                } else {
                    alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas tworzenia strefy');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas tworzenia strefy');
            });
        }

        function validateCurrentStep() {
            console.log('validateCurrentStep() called for step:', currentStep);
            
            if (currentStep === 0) {
                const zoneName = document.getElementById('zoneName');
                if (!zoneName || !zoneName.value.trim()) {
                    alert('Proszƒô wprowadziƒá nazwƒô strefy');
                    return false;
                }
                if (!selectedIcon) {
                    alert('Proszƒô wybraƒá ikonƒô strefy');
                    return false;
                }
            }
            
            if (currentStep === 1) {
                const zoneAddress = document.getElementById('zoneAddress');
                if (!zoneAddress || !zoneAddress.value.trim()) {
                    alert('Proszƒô wprowadziƒá adres strefy');
                    return false;
                }
            }
            
            return true;
        }

        function saveWizardData() {
            localStorage.setItem('wizardData', JSON.stringify(wizardData));
        }
        
        function loadWizardData() {
            const saved = localStorage.getItem('wizardData');
            if (saved) {
                wizardData = { ...wizardData, ...JSON.parse(saved) };
                
                const zoneName = document.getElementById('zoneName');
                if (zoneName && wizardData.name) {
                    zoneName.value = wizardData.name;
                }
                
                const zoneAddress = document.getElementById('zoneAddress');
                if (zoneAddress && wizardData.address) {
                    zoneAddress.value = wizardData.address;
                }
                
                const radiusSlider = document.getElementById('radiusSlider');
                const radiusValue = document.getElementById('radiusValue');
                if (radiusSlider && radiusValue && wizardData.radius) {
                    radiusSlider.value = wizardData.radius;
                    radiusValue.textContent = wizardData.radius;
                }
                
                if (wizardData.icon) {
                    selectedIcon = { name: wizardData.icon };
                    document.querySelectorAll('.icon-option').forEach(option => {
                        option.classList.remove('border-blue-500', 'bg-blue-50');
                        option.classList.add('border-gray-200');
                    });
                    const selectedOption = document.querySelector(`[data-icon="${wizardData.icon}"]`);
                    if (selectedOption) {
                        selectedOption.classList.add('border-blue-500', 'bg-blue-50');
                        selectedOption.classList.remove('border-gray-200');
                    }
                }
            }
        }

        function updateSummary() {
            const nameInput = document.getElementById('zoneName');
            const addressInput = document.getElementById('zoneAddress');
            
            if (nameInput) wizardData.name = nameInput.value;
            if (addressInput) wizardData.address = addressInput.value;
            
            const summaryName = document.getElementById('summaryName');
            const summaryAddress = document.getElementById('summaryAddress');
            const summaryRadius = document.getElementById('summaryRadius');
            const summaryNotifications = document.getElementById('summaryNotifications');
            
            if (summaryName) summaryName.textContent = wizardData.name || '-';
            if (summaryAddress) summaryAddress.textContent = wizardData.address || '-';
            if (summaryRadius) summaryRadius.textContent = wizardData.radius + 'm';
            
            const selectedDevices = document.querySelectorAll('input[type="checkbox"]:checked');
            if (summaryNotifications) {
                summaryNotifications.textContent = selectedDevices.length + ' urzƒÖdze≈Ñ';
            }
        }

        // Initialize wizard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Wizard initialized, currentStep:', currentStep);
            loadWizardData();
            
            const radiusSlider = document.getElementById('radiusSlider');
            const radiusValue = document.getElementById('radiusValue');
            
            if (radiusSlider && radiusValue) {
                radiusSlider.addEventListener('input', function() {
                    radiusValue.textContent = this.value;
                    wizardData.radius = parseInt(this.value);
                    updateSummary();
                    saveWizardData();
                });
            }
            
            const zoneName = document.getElementById('zoneName');
            if (zoneName) {
                zoneName.addEventListener('input', function() {
                    wizardData.name = this.value;
                    saveWizardData();
                });
            }
            
            const zoneAddress = document.getElementById('zoneAddress');
            if (zoneAddress) {
                zoneAddress.addEventListener('input', function() {
                    wizardData.address = this.value;
                    saveWizardData();
                });
            }
        });

        // Update summary on input changes
        document.addEventListener('input', function(e) {
            if (e.target.id === 'zoneName' || e.target.id === 'zoneAddress') {
                updateSummary();
            }
        });
    </script>
</body>
</html>
