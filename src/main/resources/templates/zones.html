<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/base}">
<head>
    <title th:text="${pageTitle} + ' - Strefy Bezpiecze≈Ñstwa'">Strefy Bezpiecze≈Ñstwa</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Zones-specific content container -->
        <div class="space-y-6">
            <!-- Page Description (i18n) -->
            <div class="text-center">
                <p class="text-gray-600 text-sm" th:text="#{zones_manage_intro}">ZarzƒÖdzaj strefami bezpiecze≈Ñstwa dla swoich bliskich</p>
            </div>
            
            <!-- Success Message -->
            <div th:if="${showDeletedMessage}" class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-green-800 font-medium">Strefa zosta≈Ça pomy≈õlnie usuniƒôta!</span>
                </div>
            </div>

            <!-- Geofencing Success Message -->
            <div id="geofencingSuccessMessage" class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4 hidden">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-green-800 font-medium" id="geofencingSuccessText">Wygenerowano zdarzenia geofencingu z powiadomieniami!</span>
                </div>
            </div>

            <!-- Zone Deletion Confirmation -->
            <div id="zoneDeleteConfirmation" class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 hidden">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-red-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-red-800 mb-2">Usu≈Ñ strefƒô</h3>
                        <p class="text-red-700 mb-4" id="zoneDeleteMessage">
                            Czy na pewno chcesz usunƒÖƒá strefƒô <strong id="zoneDeleteName">"Dom"</strong>? 
                            Ta operacja nie mo≈ºe zostaƒá cofniƒôta.
                        </p>
                        <div class="flex space-x-3">
                            <button onclick="closeDeleteConfirmation()" 
                                    class="px-4 py-2 text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg font-medium transition-colors duration-200">
                                Anuluj
                            </button>
                            <button onclick="confirmDeleteFromTop()" 
                                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors duration-200 border-0 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                                    style="background-color: #dc2626 !important;"
                                    onmouseover="this.style.backgroundColor='#b91c1c'"
                                    onmouseout="this.style.backgroundColor='#dc2626'">
                                Usu≈Ñ strefƒô
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div th:if="${showError}" class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <div>
                        <span class="text-red-800 font-medium">B≈ÇƒÖd podczas aktualizacji strefy!</span>
                        <div th:if="${errorMessage}" class="text-red-600 text-sm mt-1" th:text="${errorMessage}">Szczeg√≥≈Çy b≈Çƒôdu</div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div layout:fragment="zones-content">
                    <!-- Zones List -->
                    <div th:if="${hasZones}" class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900" th:text="#{zones_title}">Strefy Bezpiecze≈Ñstwa</h2>
                                <p class="text-gray-600 text-sm mt-1" th:text="#{zones_manage_intro}">ZarzƒÖdzaj strefami bezpiecze≈Ñstwa</p>
                            </div>
                            <div class="flex space-x-3">
                                <!-- Admin Panel Link -->
                                <a th:if="${userRole == 'ADMIN'}" th:href="@{/admin/devices}" 
                                   class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    ZarzƒÖdzanie urzƒÖdzeniami
                                </a>
                                <button th:if="${userRole != 'VIEWER'}" onclick="startZoneWizard()" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                                    <span th:text="'+' + ' ' + #{add_zone}">+ Dodaj strefƒô</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Zones Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div th:each="zone : ${zones}" 
                                 class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1">
                                
                                <!-- Zone Header -->
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center">
                                        <!-- Home Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-blue-100" 
                                             th:if="${zone.icon == 'home'}">
                                            <span class="text-2xl">üè†</span>
                                        </div>
                                        <!-- School Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-green-100" 
                                             th:if="${zone.icon == 'school'}">
                                            <span class="text-2xl">üè´</span>
                                        </div>
                                        <!-- Work Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-purple-100" 
                                             th:if="${zone.icon == 'work'}">
                                            <span class="text-2xl">üè¢</span>
                                        </div>
                                        <!-- Hospital Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-orange-100" 
                                             th:if="${zone.icon == 'hospital'}">
                                            <span class="text-2xl">üè•</span>
                                        </div>
                                        <!-- Gym Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-red-100" 
                                             th:if="${zone.icon == 'gym'}">
                                            <span class="text-2xl">üí™</span>
                                        </div>
                                        <!-- Park Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-emerald-100" 
                                             th:if="${zone.icon == 'park'}">
                                            <span class="text-2xl">üå≥</span>
                                        </div>
                                        <!-- Shop Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-yellow-100" 
                                             th:if="${zone.icon == 'shop'}">
                                            <span class="text-2xl">üõí</span>
                                        </div>
                                        <!-- Restaurant Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-pink-100" 
                                             th:if="${zone.icon == 'restaurant'}">
                                            <span class="text-2xl">üçΩÔ∏è</span>
                                        </div>
                                        <!-- Default Icon -->
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 bg-gray-100" 
                                             th:unless="${zone.icon == 'home' or zone.icon == 'school' or zone.icon == 'work' or zone.icon == 'hospital' or zone.icon == 'gym' or zone.icon == 'park' or zone.icon == 'shop' or zone.icon == 'restaurant'}">
                                            <span class="text-2xl">üìç</span>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-900 text-lg" th:text="${zone.name}">Nazwa strefy</h3>
                                            <p class="text-sm text-gray-500" th:text="${zone.address}">Adres</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a th:if="${userRole == 'ADMIN' or userRole == 'USER'}" th:href="@{/zones/edit/{id}(id=${zone.id})}" 
                                           class="text-gray-400 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition-colors duration-200"
                                           title="Edytuj strefƒô">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </a>
                                        <button th:if="${userRole == 'ADMIN'}" th:data-zone-id="${zone.id}" 
                                                th:data-zone-name="${zone.name}"
                                                onclick="deleteZoneFromButton(this)" 
                                                class="text-gray-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors duration-200"
                                                title="Usu≈Ñ strefƒô">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Zone Stats -->
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="flex items-center text-sm text-gray-600">
                                        <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                        </svg>
                                        <span th:text="#{devices_count(${zone.deviceCount})}">2 urzƒÖdze≈Ñ</span>
                                    </div>
                                    <div class="flex items-center text-sm text-gray-600">
                                        <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <span th:text="${zone.radius} + 'm'">500m</span>
                                    </div>
                                </div>
                                
                                <!-- Notifications Toggle -->
                                <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.828 7l2.586 2.586a2 2 0 002.828 0L12 7H4.828zM4.828 17l2.586-2.586a2 2 0 012.828 0L12 17H4.828z"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-gray-700" th:text="#{zone_notifications}">Powiadomienia</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" 
                                               th:checked="${zone.notificationsEnabled}"
                                               th:data-zone-id="${zone.id}"
                                               onchange="toggleNotificationsFromCheckbox(this)"
                                               th:disabled="${userRole == 'VIEWER'}"
                                               class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                                
                                <!-- Device List -->
                                <div class="border-t border-gray-100 pt-3">
                                    <p class="text-xs text-gray-500 mb-2" th:text="#{choose_devices}">Przypisane urzƒÖdzenia:</p>
                                    <div class="flex flex-wrap gap-1">
                                        <span th:each="device : ${zone.deviceIds}" 
                                              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                            </svg>
                                            <span th:text="${deviceIdToName[device] != null ? deviceIdToName[device] : (deviceIdToName[device + ''] != null ? deviceIdToName[device + ''] : device)}">iPhone 13</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden zones dataset for map -->
                        <div id="zonesData" style="display:none;">
                            <div th:each="z : ${zones}"
                                 th:attr="data-id=${z.id},data-lat=${z.latitude},data-lng=${z.longitude},data-icon=${z.icon},data-name=${z.name},data-radius=${z.radius}"></div>
                        </div>

                        <!-- Zones Map -->
                        <div class="mt-10">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3" th:text="#{zones_map}">Mapa stref</h3>
                            <div class="mb-4 flex items-center gap-4">
                                <button type="button" onclick="requestNotifyPermission()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">W≈ÇƒÖcz powiadomienia</button>
                                <button th:if="${userRole != 'VIEWER'}" type="button" onclick="simulateGeo()" class="bg-white hover:bg-gray-50 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg border border-gray-300">Symuluj zdarzenia</button>
                            </div>
                            <div id="zonesMap" class="w-full bg-gray-100 rounded-xl border border-gray-200" style="height:400px;"></div>
                        </div>
                    </div>
                    
                    <!-- Onboarding Empty State -->
                    <div th:unless="${hasZones}" class="p-12 text-center">
                        <div class="max-w-2xl mx-auto">
                            <!-- Main Title -->
                            <h2 class="text-3xl font-bold text-gray-900 mb-4" th:text="#{zones_title}">Strefy Bezpiecze≈Ñstwa</h2>
                            
                            <!-- Intro Text -->
                            <p class="text-lg text-gray-600 mb-8 max-w-xl mx-auto" th:text="#{zones_empty_description}">
                                Stw√≥rz strefy bezpiecze≈Ñstwa dla swoich bliskich. Otrzymuj powiadomienia, gdy cz≈Çonkowie rodziny wchodzƒÖ lub wychodzƒÖ z okre≈õlonych miejsc.
                            </p>
                            
                            <!-- Example Icons -->
                            <div class="flex justify-center items-center space-x-8 mb-8">
                                <div class="flex flex-col items-center">
                                    <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mb-2">
                                        <span class="text-3xl">üè†</span>
                                    </div>
                                    <span class="text-sm text-gray-600">Dom</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mb-2">
                                        <span class="text-3xl">üè´</span>
                                    </div>
                                    <span class="text-sm text-gray-600">Szko≈Ça</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mb-2">
                                        <span class="text-3xl">üè¢</span>
                                    </div>
                                    <span class="text-sm text-gray-600">Praca</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="w-16 h-16 bg-orange-100 rounded-2xl flex items-center justify-center mb-2">
                                        <span class="text-3xl">üè•</span>
                                    </div>
                                    <span class="text-sm text-gray-600">Szpital</span>
                                </div>
                            </div>
                            
                            <!-- Call to Action -->
                            <button th:if="${userRole != 'VIEWER'}" onclick="startZoneWizard()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                                <span th:text="'+' + ' ' + #{add_first_zone}">+ Dodaj pierwszƒÖ strefƒô</span>
                            </button>
                            
                            <!-- Additional Info -->
                            <p class="text-sm text-gray-500 mt-6" th:text="#{zone_created_description}">
                                Kliknij przycisk powy≈ºej, aby rozpoczƒÖƒá kreator tworzenia strefy bezpiecze≈Ñstwa
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">

    <script th:inline="javascript">
        // Start zone creation wizard
        window.startZoneWizard = function() {
            var role = /*[[${userRole}]]*/ 'VIEWER';
            if (role === 'VIEWER') { showNotificationMessage('Brak uprawnie≈Ñ do tworzenia stref', 'error'); return; }
            window.location.href = '/zones/wizard?step=0';
        }
        
        // Delete zone with enhanced confirmation modal
        window.deleteZone = function(zoneId, zoneName) {
            showDeleteConfirmation(zoneId, zoneName);
        }
        
        // Delete zone from button element (using data attributes)
        window.deleteZoneFromButton = function(button) {
            const zoneId = button.getAttribute('data-zone-id');
            const zoneName = button.getAttribute('data-zone-name');
            deleteZone(zoneId, zoneName);
        }
        
        function showDeleteConfirmation(zoneId, zoneName) {
            // Hide any existing confirmation
            const existingConfirmation = document.getElementById('zoneDeleteConfirmation');
            if (existingConfirmation) {
                existingConfirmation.classList.add('hidden');
            }
            
            // Update the message with the zone name
            const zoneNameElement = document.getElementById('zoneDeleteName');
            if (zoneNameElement) {
                zoneNameElement.textContent = `"${zoneName}"`;
            }
            
            // Store the zone ID for the confirmation
            window.pendingDeleteZoneId = zoneId;
            
            // Show the confirmation
            if (existingConfirmation) {
                existingConfirmation.classList.remove('hidden');
            }
        }
        
        function closeDeleteModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }
        
        function closeDeleteConfirmation() {
            const confirmation = document.getElementById('zoneDeleteConfirmation');
            if (confirmation) {
                confirmation.classList.add('hidden');
            }
            // Clear the pending delete zone ID
            window.pendingDeleteZoneId = null;
        }
        
        function confirmDeleteFromTop() {
            const zoneId = window.pendingDeleteZoneId;
            if (zoneId) {
                confirmDelete(zoneId);
                closeDeleteConfirmation();
            }
        }
        
        function confirmDelete(zoneId) {
            closeDeleteModal();
            closeDeleteConfirmation();
            
            // Show loading state
            const deleteButton = document.querySelector(`button[onclick*="deleteZone(${zoneId}"]`);
            if (deleteButton) {
                const originalContent = deleteButton.innerHTML;
                deleteButton.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                deleteButton.disabled = true;
            }
            
            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/zones/delete/${zoneId}`;
            
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
        
        // Toggle notifications for a zone
        window.toggleNotifications = function(zoneId, enabled) {
            // Show loading state on the toggle
            const toggle = document.querySelector(`input[data-zone-id="${zoneId}"]`);
            if (toggle) {
                toggle.disabled = true;
            }
            
            fetch(`/api/zones/${zoneId}/notifications?enabled=${enabled}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Show success message
                    showNotificationMessage(
                        enabled ? 'Powiadomienia w≈ÇƒÖczone' : 'Powiadomienia wy≈ÇƒÖczone',
                        enabled ? 'success' : 'info'
                    );
                } else {
                    // Revert toggle state
                    if (toggle) {
                        toggle.checked = !enabled;
                    }
                    showNotificationMessage('B≈ÇƒÖd podczas zmiany ustawie≈Ñ powiadomie≈Ñ', 'error');
                }
            })
            .catch(error => {
                // Revert toggle state
                if (toggle) {
                    toggle.checked = !enabled;
                }
                showNotificationMessage('B≈ÇƒÖd podczas zmiany ustawie≈Ñ powiadomie≈Ñ', 'error');
            })
            .finally(() => {
                // Re-enable toggle
                if (toggle) {
                    toggle.disabled = false;
                }
            });
        }
        
        // Toggle notifications from checkbox element (using data attributes)
        window.toggleNotificationsFromCheckbox = function(checkbox) {
            const zoneId = checkbox.getAttribute('data-zone-id');
            const enabled = checkbox.checked;
            toggleNotifications(zoneId, enabled);
        }
        
        function showNotificationMessage(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'warning' ? 'bg-yellow-500 text-white' :
                type === 'info' ? 'bg-blue-500 text-white' :
                'bg-gray-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        function showGeofencingSuccessMessage(message) {
            // Hide any existing geofencing success message
            const existingMessage = document.getElementById('geofencingSuccessMessage');
            if (existingMessage) {
                existingMessage.classList.add('hidden');
            }
            
            // Update the message text
            const messageText = document.getElementById('geofencingSuccessText');
            if (messageText) {
                messageText.textContent = message;
            }
            
            // Show the message
            if (existingMessage) {
                existingMessage.classList.remove('hidden');
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    existingMessage.classList.add('hidden');
                }, 5000);
            }
        }
        
        window.requestNotifyPermission = function() {
            if (!('Notification' in window)) { 
                alert('Powiadomienia nie sƒÖ wspierane w tej przeglƒÖdarce'); 
                return; 
            }
            
            // Check if we're in a secure context (HTTPS or localhost)
            if (!window.isSecureContext) {
                alert('Powiadomienia wymagajƒÖ bezpiecznego po≈ÇƒÖczenia (HTTPS)');
                return;
            }
            
            Notification.requestPermission().then((permission) => {
                console.log('Permission request result:', permission);
                if (permission === 'granted') {
                    showNotificationMessage('Powiadomienia aktywne!', 'success');
                    // Test notification to ensure it works
                    testNotification();
                } else if (permission === 'denied') {
                    showNotificationMessage('Powiadomienia zosta≈Çy zablokowane. W≈ÇƒÖcz je w ustawieniach przeglƒÖdarki.', 'error');
                } else {
                    showNotificationMessage('Brak zgody na powiadomienia', 'warning');
                }
            }).catch((error) => {
                console.error('Error requesting notification permission:', error);
                showNotificationMessage('B≈ÇƒÖd podczas w≈ÇƒÖczania powiadomie≈Ñ', 'error');
            });
        }
        
        function testNotification() {
            try {
                const notification = new Notification('Test powiadomie≈Ñ', {
                    body: 'Powiadomienia dzia≈ÇajƒÖ poprawnie!',
                    tag: 'test-notification',
                    requireInteraction: false
                });
                
                // Auto close test notification after 3 seconds
                setTimeout(() => {
                    notification.close();
                }, 3000);
            } catch (error) {
                console.error('Error creating test notification:', error);
            }
        }
        window.simulateGeo = function() {
            var role = /*[[${userRole}]]*/ 'VIEWER';
            if (role === 'VIEWER') { showNotificationMessage('Brak uprawnie≈Ñ do symulacji', 'error'); return; }
            
            // Get all zones
            const allZones = document.querySelectorAll('#zonesData > div');
            if (allZones.length === 0) { showNotificationMessage('Brak stref do symulacji', 'error'); return; }
            
            // Find the first zone with notifications enabled
            let selectedZone = null;
            let selectedZoneId = null;
            
            for (let i = 0; i < allZones.length; i++) {
                const zone = allZones[i];
                const zoneIdAttr = zone.getAttribute('data-id');
                if (!zoneIdAttr) continue;
                
                const zoneId = parseInt(zoneIdAttr, 10);
                if (Number.isNaN(zoneId)) continue;
                
                // Check if this zone has notifications enabled
                const checkbox = document.querySelector(`input[data-zone-id="${zoneId}"]`);
                const notificationsEnabled = checkbox ? checkbox.checked : false;
                
                console.log(`Checking zone ${zoneId}: notifications enabled = ${notificationsEnabled}`);
                
                if (notificationsEnabled) {
                    selectedZone = zone;
                    selectedZoneId = zoneId;
                    console.log(`Selected zone ${zoneId} for simulation (notifications enabled)`);
                    break;
                }
            }
            
            if (!selectedZone) {
                showNotificationMessage('Brak stref z w≈ÇƒÖczonymi powiadomieniami do symulacji', 'warning');
                return;
            }
            
            const zoneId = selectedZoneId;
            
            // Check notification permission and request if needed
            if (!('Notification' in window)) {
                showNotificationMessage('Powiadomienia nie sƒÖ wspierane w tej przeglƒÖdarce', 'error');
                return;
            }
            
            // Check if we're in a secure context (HTTPS or localhost)
            if (!window.isSecureContext) {
                showNotificationMessage('Powiadomienia wymagajƒÖ bezpiecznego po≈ÇƒÖczenia (HTTPS)', 'error');
                return;
            }
            
            if (Notification.permission === 'denied') {
                showNotificationMessage('Powiadomienia zosta≈Çy zablokowane. W≈ÇƒÖcz je w ustawieniach przeglƒÖdarki.', 'error');
                return;
            }
            
            if (Notification.permission === 'default') {
                console.log('Requesting notification permission...');
                Notification.requestPermission().then((permission) => {
                    console.log('Permission request result:', permission);
                    if (permission === 'granted') {
                        showNotificationMessage('Powiadomienia w≈ÇƒÖczone! Uruchamiam symulacjƒô...', 'success');
                        setTimeout(() => simulateGeofenceEvents(zoneId), 1000);
                    } else {
                        showNotificationMessage('Brak zgody na powiadomienia. Uruchamiam symulacjƒô bez powiadomie≈Ñ...', 'warning');
                        setTimeout(() => simulateGeofenceEvents(zoneId), 1000);
                    }
                });
            } else {
                console.log('Permission already set to:', Notification.permission);
                simulateGeofenceEvents(zoneId);
            }
        }
        
        function simulateGeofenceEvents(zoneId) {
            // First, check if notifications are enabled for this zone
            const checkbox = document.querySelector(`input[data-zone-id="${zoneId}"]`);
            const notificationsEnabled = checkbox ? checkbox.checked : false;
            
            console.log('Zone notifications enabled:', notificationsEnabled);
            console.log('Zone ID:', zoneId);
            console.log('Checkbox found:', checkbox);
            
            fetch(`/api/geofence/events/${zoneId}?count=3`).then(r=>{
                if (!r.ok) throw new Error('HTTP '+r.status);
                return r.json();
            }).then(events=>{
                console.log('Mock events', events);
                console.log('Notification permission status:', Notification.permission);
                const count = Array.isArray(events) ? events.length : 0;
                
                // Check if notifications are enabled for this zone AND browser permission is granted
                if (Notification.permission === 'granted' && notificationsEnabled) {
                    console.log('Creating notifications...');
                    (events || []).forEach((e, index) => {
                        setTimeout(() => {
                            try {
                                console.log(`Creating notification ${index + 1}:`, e.eventType, e.zoneName);
                                const notification = new Notification(`${e.eventType} ‚Ä¢ ${e.zoneName}`, { 
                                    body: `${e.deviceName} @ ${e.latitude.toFixed(5)}, ${e.longitude.toFixed(5)}`,
                                    tag: `geofence-${e.eventType}-${index}`,
                                    requireInteraction: false,
                                    silent: false
                                });
                                
                                // Auto close notification after 5 seconds
                                setTimeout(() => {
                                    notification.close();
                                }, 5000);
                                
                                // Handle notification click
                                notification.onclick = function() {
                                    console.log('Notification clicked:', e.eventType, e.zoneName);
                                    notification.close();
                                };
                                
                            } catch (error) {
                                console.error('Error creating notification:', error);
                            }
                        }, index * 1000); // Stagger notifications by 1 second
                    });
                    showGeofencingSuccessMessage(`Wygenerowano ${count} zdarze≈Ñ geofencingu z powiadomieniami`);
                } else if (!notificationsEnabled) {
                    console.log('Notifications disabled for this zone');
                    showGeofencingSuccessMessage(`Wygenerowano ${count} zdarze≈Ñ geofencingu (powiadomienia wy≈ÇƒÖczone dla tej strefy)`);
                } else {
                    console.log('Notification permission not granted:', Notification.permission);
                    showGeofencingSuccessMessage(`Wygenerowano ${count} zdarze≈Ñ geofencingu (bez powiadomie≈Ñ)`);
                }
            }).catch((err)=> {
                console.error('simulateGeo error', err);
                showNotificationMessage('B≈ÇƒÖd symulacji geofencingu', 'error')
            });
        }
    
        // Logout functionality
        window.logout = async function() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.redirectUrl) {
                    window.location.href = data.redirectUrl;
                }
            } catch (error) {
                window.location.href = '/auth/login';
            }
        }
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script th:if="${hasZones}">
        document.addEventListener('DOMContentLoaded', function() {
            const zones = Array.from(document.querySelectorAll('#zonesData > div')).map(el => ({
                latitude: parseFloat(el.getAttribute('data-lat')),
                longitude: parseFloat(el.getAttribute('data-lng')),
                icon: el.getAttribute('data-icon') || 'pin',
                name: el.getAttribute('data-name') || '',
                radius: parseInt(el.getAttribute('data-radius')) || 500
            })).filter(z => !Number.isNaN(z.latitude) && !Number.isNaN(z.longitude));
            const mapEl = document.getElementById('zonesMap');
            if (!mapEl) return;
            const center = zones.length ? [zones[0].latitude || 52.2297, zones[0].longitude || 21.0122] : [52.2297, 21.0122];
            const map = L.map(mapEl).setView(center, 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const bounds = L.latLngBounds();
            const emojiMap = {home:'üè†',school:'üè´',work:'üè¢',hospital:'üè•',gym:'üí™',park:'üå≥',shop:'üõí',restaurant:'üçΩÔ∏è'};
            zones.forEach(z => {
                const pos = [z.latitude, z.longitude];
                const emoji = emojiMap[z.icon] || 'üìç';
                const icon = L.divIcon({html: `<div style="font-size:20px;">${emoji}</div>`, className: 'emoji-marker', iconSize: [20, 20], iconAnchor: [10, 10]});
                L.marker(pos, { icon, title: z.name }).addTo(map);
                L.circle(pos, { radius: z.radius || 500, color: '#2563eb', weight: 1, fillColor: '#3b82f6', fillOpacity: 0.1 }).addTo(map);
                bounds.extend(pos);
            });
            // User location from browser
            let userMarker;
            let userAccuracyCircle;
            map.on('locationfound', function(e) {
                const pos = e.latlng;
                const userIcon = L.divIcon({ html: '<div style="width:10px;height:10px;background:#10b981;border:2px solid #fff;border-radius:50%;box-shadow:0 0 0 2px rgba(16,185,129,0.35);"></div>', className: 'user-location', iconSize: [14, 14], iconAnchor: [7, 7] });
                if (!userMarker) {
                    userMarker = L.marker(pos, { icon: userIcon, title: 'Your location' }).addTo(map);
                    userAccuracyCircle = L.circle(pos, { radius: e.accuracy || 30, color: '#10b981', weight: 1, fillColor: '#34d399', fillOpacity: 0.15 }).addTo(map);
                } else {
                    userMarker.setLatLng(pos);
                    if (userAccuracyCircle) userAccuracyCircle.setLatLng(pos).setRadius(e.accuracy || 30);
                }
                bounds.extend(pos);
                map.fitBounds(bounds, { padding: [20, 20] });
            });
            map.on('locationerror', function() { /* ignore */ });
            map.locate({ setView: false, enableHighAccuracy: true });
            if (zones.length > 1) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
            // Ensure proper sizing after layout
            setTimeout(() => map.invalidateSize(), 200);
        });
    </script>

    </th:block>

</body>
</html>
