<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/base}">
<head>
    <title>Kreator strefy - Bezpieczna Rodzina</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Wizard Container -->
        <div class="max-w-4xl mx-auto" th:data-current-step="${currentStep}">
            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center" th:each="step, iterStat : ${wizardSteps}">
                            <div class="flex items-center">
                                <!-- Completed step -->
                                <div th:if="${iterStat.index < currentStep}" 
                                     class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-green-500 text-white">
                                    <span th:text="${iterStat.index + 1}">1</span>
                                </div>
                                <!-- Current step -->
                                <div th:if="${iterStat.index == currentStep}" 
                                     class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-blue-500 text-white">
                                    <span th:text="${iterStat.index + 1}">1</span>
                                </div>
                                <!-- Future step -->
                                <div th:if="${iterStat.index > currentStep}" 
                                     class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-gray-200 text-gray-500">
                                    <span th:text="${iterStat.index + 1}">1</span>
                                </div>
                                
                                <!-- Step title -->
                                <span th:if="${iterStat.index <= currentStep}"
                                      class="ml-2 text-sm font-medium text-gray-900"
                                      th:text="${iterStat.index == 0} ? #{wizard_step1_title} : (${iterStat.index == 1} ? #{wizard_step2_title} : (${iterStat.index == 2} ? #{wizard_step3_title} : #{wizard_step4_title}))">Krok</span>
                                <span th:if="${iterStat.index > currentStep}"
                                      class="ml-2 text-sm font-medium text-gray-500"
                                      th:text="${iterStat.index == 0} ? #{wizard_step1_title} : (${iterStat.index == 1} ? #{wizard_step2_title} : (${iterStat.index == 2} ? #{wizard_step3_title} : #{wizard_step4_title}))">Krok</span>
                            </div>
                            <div th:if="${!iterStat.last}" class="w-8 h-0.5 bg-gray-200 mx-2"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        <span th:if="${currentStep} == 0" th:text="#{step_1_of_4}">Krok 1 z 4</span>
                        <span th:if="${currentStep} == 1" th:text="#{step_2_of_4}">Krok 2 z 4</span>
                        <span th:if="${currentStep} == 2" th:text="#{step_3_of_4}">Krok 3 z 4</span>
                        <span th:if="${currentStep} == 3" th:text="#{step_4_of_4}">Krok 4 z 4</span>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div th:style="'width: ' + ${(currentStep + 1) * 100 / wizardSteps.size()} + '%'"
                         class="bg-blue-500 h-2 rounded-full transition-all duration-300"></div>
                </div>
            </div>

            <!-- Hidden inputs for edit mode data -->
            <div th:if="${isEditMode and existingZone != null}" style="display: none;">
                <input type="hidden" id="editZoneId" th:value="${existingZone.id}">
                <input type="hidden" id="editZoneName" th:value="${existingZone.name}">
                <input type="hidden" id="editZoneIcon" th:value="${existingZone.icon}">
                <input type="hidden" id="editZoneAddress" th:value="${existingZone.address}">
                <input type="hidden" id="editZoneRadius" th:value="${existingZone.radius}">
                <input type="hidden" id="editZoneDeviceIds" th:value="${existingZone.deviceIds != null ? #strings.listJoin(existingZone.deviceIds, ',') : ''}">
            </div>

            <!-- Wizard Content -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                <div class="p-8">
                    <!-- Step 1: Zone Name & Icon -->
                    <div th:if="${currentStep == 0}" class="space-y-6">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2" th:text="#{wizard_step1_title}">Nazwa i ikona strefy</h2>
                            <p class="text-gray-600" th:text="#{wizard_step1_desc}">Wybierz nazwƒô i ikonƒô dla swojej strefy bezpiecze≈Ñstwa</p>
                        </div>
                        
                        <!-- Zone Name Input -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700" th:text="#{zone_name}">Nazwa strefy</label>
                            <input type="text" 
                                   id="zoneName" 
                                   th:placeholder="#{zone_name_placeholder}"
                                   th:value="${existingZone?.name}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <!-- Icon Selection -->
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700" th:text="#{choose_icon}">Wybierz ikonƒô</label>
                            <div class="grid grid-cols-4 gap-4">
                                <div th:each="icon : ${availableIcons}" 
                                     class="icon-option cursor-pointer p-4 border-2 border-gray-200 rounded-lg text-center hover:border-blue-300 transition-colors duration-200"
                                     th:data-icon="${icon.name}"
                                     th:data-emoji="${icon.emoji}"
                                     onclick="selectIconFromElement(this)">
                                    <div class="text-3xl mb-2" th:text="${icon.emoji}">üè†</div>
                                    <div class="text-sm text-gray-600" th:text="${#messages.msg('icon_' + icon.name)}">Dom</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Location -->
                    <div th:if="${currentStep == 1}" class="space-y-6">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2" th:text="#{wizard_step2_title}">Lokalizacja strefy</h2>
                            <p class="text-gray-600" th:text="#{wizard_step2_desc}">Wprowad≈∫ adres lub wybierz lokalizacjƒô na mapie</p>
                        </div>
                        
                        <!-- Address Input -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700" th:text="#{zone_address}">Adres</label>
                            <input type="text" 
                                   id="zoneAddress" 
                                   th:placeholder="#{zone_address_placeholder}"
                                   th:value="${existingZone?.address}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <!-- Map Placeholder -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700" th:text="#{set_location}">Mapa</label>
                            <div class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                                <div class="text-center">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <p class="text-gray-500" th:text="#{set_zone_area}">Mapa bƒôdzie dostƒôpna w nastƒôpnej fazie rozwoju</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Radius -->
                    <div th:if="${currentStep == 2}" class="space-y-6">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2" th:text="#{wizard_step3_title}">Promie≈Ñ strefy</h2>
                            <p class="text-gray-600" th:text="#{wizard_step3_desc}">Ustaw promie≈Ñ strefy bezpiecze≈Ñstwa</p>
                        </div>
                        
                        <!-- Radius Slider -->
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="text-4xl font-bold text-blue-600 mb-2">
                                    <span id="radiusValue">500</span>m
                                </div>
                                <p class="text-gray-500" th:text="#{zone_radius}">Promie≈Ñ strefy</p>
                            </div>
                            
                            <div class="px-4">
                                <input type="range" 
                                       id="radiusSlider" 
                                       min="100" 
                                       max="5000" 
                                       th:value="${existingZone?.radius ?: 500}" 
                                       step="50"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            
                            <!-- Quick Radius Buttons -->
                            <div class="flex justify-center space-x-2">
                                <button type="button" 
                                        onclick="setRadius(100)" 
                                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
                                    100m
                                </button>
                                <button type="button" 
                                        onclick="setRadius(500)" 
                                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
                                    500m
                                </button>
                                <button type="button" 
                                        onclick="setRadius(1000)" 
                                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
                                    1km
                                </button>
                                <button type="button" 
                                        onclick="setRadius(2000)" 
                                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200">
                                    2km
                                </button>
                            </div>
                        </div>
                        
                        <!-- Map Preview Placeholder -->
                        <div class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                            <div class="text-center">
                                <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <p class="text-gray-500 text-sm">PodglƒÖd mapy z okrƒôgiem promienia</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Notifications -->
                    <div th:if="${currentStep == 3}" class="space-y-6">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2" th:text="#{wizard_step4_title}">Powiadomienia</h2>
                            <p class="text-gray-600" th:text="#{wizard_step4_desc}">Wybierz urzƒÖdzenia, kt√≥re bƒôdƒÖ otrzymywaƒá powiadomienia</p>
                        </div>
                        
                        <!-- Device List -->
                        <div class="space-y-4">
                            <div th:each="device : ${userDevices}" 
                                 class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-900" th:text="${device.name}">iPhone 13</h3>
                                        <p class="text-sm text-gray-500" th:text="${device.type}">Telefon</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" 
                                           th:value="${device.id}"
                                           class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Summary -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-medium text-gray-900 mb-2" th:text="#{zones_title}">Podsumowanie strefy</h3>
                            <div class="space-y-1 text-sm text-gray-600">
                                <div class="flex justify-between">
                                    <span th:text="#{zone_name}">Nazwa:</span>
                                    <span id="summaryName" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span th:text="#{zone_icon}">Ikona:</span>
                                    <span id="summaryIcon" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span th:text="#{zone_address}">Adres:</span>
                                    <span id="summaryAddress" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span th:text="#{zone_radius}">Promie≈Ñ:</span>
                                    <span id="summaryRadius" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wizard Navigation -->
                <div class="flex justify-between items-center p-6 bg-gray-50 rounded-b-xl">
                    <button type="button" 
                            th:if="${currentStep > 0}"
                            onclick="previousStep()" 
                            class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors duration-200">
                        ‚Üê <span th:text="#{back}">Wstecz</span>
                    </button>
                    <div th:unless="${currentStep > 0}" class="w-20"></div>
                    
                    <div class="flex space-x-3">
                        <button type="button" 
                                onclick="cancelWizard()" 
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors duration-200">
                            <span th:text="#{cancel}">Anuluj</span>
                        </button>
                        <button type="button" 
                                th:if="${currentStep < 3}"
                                onclick="nextStep();" 
                                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                            <span th:text="#{next}">Dalej</span> ‚Üí
                        </button>
                        <button type="button" 
                                th:if="${currentStep == 3}"
                                onclick="saveZone()" 
                                class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200">
                            <span th:text="#{save_zone}">Zapisz strefƒô</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script>
        // Global variables
        let selectedIcon = null;
        let currentStep = /*[[${currentStep}]]*/ 0;
        let isEditMode = false;
        let existingZoneId = null;
        
        // Icon mapping function
        function getIconEmoji(iconName) {
            const iconMap = {
                'home': 'üè†',
                'school': 'üè´',
                'work': 'üè¢',
                'hospital': 'üè•',
                'gym': 'üí™',
                'park': 'üå≥',
                'shop': 'üõí',
                'restaurant': 'üçΩÔ∏è'
            };
            return iconMap[iconName] || 'üìç';
        }
        
        // Get current step from URL parameter
        function getCurrentStepFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const step = urlParams.get('step');
            return step ? parseInt(step) : 0;
        }
        
        // Update currentStep from URL
        currentStep = getCurrentStepFromUrl();
        
        // Function to attach event listeners to form fields
        function attachFormEventListeners() {
            // Attach to name input if it exists
            const nameInput = document.getElementById('zoneName');
            if (nameInput) {
                // Remove existing listeners first
                nameInput.removeEventListener('input', handleNameChange);
                nameInput.addEventListener('input', handleNameChange);
            }
            
            // Attach to address input if it exists
            const addressInput = document.getElementById('zoneAddress');
            if (addressInput) {
                // Remove existing listeners first
                addressInput.removeEventListener('input', handleAddressChange);
                addressInput.addEventListener('input', handleAddressChange);
            }
        }
        
        // Event handler functions
        function handleNameChange(event) {
            wizardData.name = event.target.value.trim();
            saveWizardData();
        }
        
        function handleAddressChange(event) {
            wizardData.address = event.target.value.trim();
            saveWizardData();
        }
        
        let wizardData = {
            name: '',
            icon: '',
            address: '',
            radius: 500,
            devices: [],
            deviceIds: [],
            devicesCount: 0
        };

        // Initialize form with existing data if in edit mode
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're in edit mode by looking for the edit zone ID input
            const editZoneIdInput = document.getElementById('editZoneId');
            if (editZoneIdInput) {
                isEditMode = true;
                existingZoneId = editZoneIdInput.value;
                
                // Always initialize edit mode first to get device data from database
                initializeEditMode();
                
                // Then load any saved data from localStorage to preserve user changes
                const savedData = localStorage.getItem('wizardData');
                if (savedData) {
                    loadWizardData();
                }
            } else {
                // Load any saved wizard data from localStorage
                loadWizardData();
            }
            
            // Attach event listeners to form fields
            attachFormEventListeners();
        });

        function initializeEditMode() {
            // Read data from hidden inputs
            const editZoneId = document.getElementById('editZoneId');
            const editZoneName = document.getElementById('editZoneName');
            const editZoneIcon = document.getElementById('editZoneIcon');
            const editZoneAddress = document.getElementById('editZoneAddress');
            const editZoneRadius = document.getElementById('editZoneRadius');
            const editZoneDeviceIds = document.getElementById('editZoneDeviceIds');
            
            if (!editZoneId) {
                return;
            }
            
            // Pre-fill form data from existing zone
            const existingZone = {
                id: editZoneId.value,
                name: editZoneName ? editZoneName.value : '',
                icon: editZoneIcon ? editZoneIcon.value : '',
                address: editZoneAddress ? editZoneAddress.value : '',
                radius: editZoneRadius ? parseInt(editZoneRadius.value) : 500,
                deviceIds: editZoneDeviceIds ? editZoneDeviceIds.value.split(',').filter(id => id.trim()) : []
            };
            
            // Pre-fill wizard data from database (this is the base data)
            wizardData.name = existingZone.name || '';
            wizardData.icon = existingZone.icon || '';
            wizardData.address = existingZone.address || '';
            wizardData.radius = existingZone.radius || 500;
            wizardData.deviceIds = existingZone.deviceIds || [];
            
            // Ensure selectedIcon is set for edit mode
            if (wizardData.icon) {
                selectedIcon = { name: wizardData.icon, emoji: getIconEmoji(wizardData.icon) };
            }
            
            // Pre-fill form fields (only if they exist on current step)
            const nameInput = document.getElementById('zoneName');
            const addressInput = document.getElementById('zoneAddress');
            
            if (nameInput) {
                nameInput.value = existingZone.name || '';
                
                // Add event listener to save name changes immediately
                nameInput.addEventListener('input', function() {
                    wizardData.name = this.value.trim();
                    saveWizardData();
                });
            }
            if (addressInput) {
                addressInput.value = existingZone.address || '';
                
                // Add event listener to save address changes immediately
                addressInput.addEventListener('input', function() {
                    wizardData.address = this.value.trim();
                    saveWizardData();
                });
            }
            
            // Pre-select icon if it exists and we're on step 0
            if (existingZone.icon && currentStep === 0) {
                const iconElement = document.querySelector(`[data-icon="${existingZone.icon}"]`);
                if (iconElement) {
                    selectIconFromElement(iconElement);
                }
            }
            
            // Store device IDs for later selection when step 3 is reached
            if (existingZone.deviceIds && existingZone.deviceIds.length > 0) {
                // Store in wizardData for later use
                wizardData.deviceIds = existingZone.deviceIds;
                wizardData.devicesCount = existingZone.deviceIds.length;
            }
            
            // Update radius display if we're on step 2
            if (currentStep === 2) {
                const radiusSlider = document.getElementById('radiusSlider');
                const radiusValue = document.getElementById('radiusValue');
                if (radiusSlider && radiusValue) {
                    radiusSlider.value = existingZone.radius || 500;
                    radiusValue.textContent = existingZone.radius || 500;
                }
            }
        }

        // Navigation functions - defined globally
        window.nextStep = function() {
            // Save current step data before validation
            saveCurrentStepData();
            
            if (validateCurrentStep()) {
                // Save current step data before moving to next step
                saveWizardData();
                
                const nextStep = currentStep + 1;
                
                if (nextStep < 4) {
                    // Build URL with edit parameters if in edit mode
                    let url = `/zones/wizard?step=${nextStep}`;
                    if (isEditMode && existingZoneId) {
                        url += `&edit=true&id=${existingZoneId}`;
                    }
                    window.location.href = url;
                }
                
                // If moving to step 3, pre-select devices after a short delay
                if (nextStep === 3) {
                    // Don't call loadWizardData here as it resets deviceIds
                    setTimeout(() => {
                        preSelectDevices();
                    }, 100);
                } else {
                    // Only call loadWizardData for other steps
                    loadWizardData();
                }
            }
        }

        window.previousStep = function() {
            const prevStep = currentStep - 1;
            if (prevStep >= 0) {
                // Build URL with edit parameters if in edit mode
                let url = `/zones/wizard?step=${prevStep}`;
                if (isEditMode && existingZoneId) {
                    url += `&edit=true&id=${existingZoneId}`;
                }
                window.location.href = url;
            }
        }

        window.cancelWizard = function() {
            if (confirm('Czy na pewno chcesz anulowaƒá tworzenie strefy? Wszystkie wprowadzone dane zostanƒÖ utracone.')) {
                localStorage.removeItem('wizardData');
                window.location.href = '/zones';
            }
        }

        window.selectIcon = function(iconName, iconEmoji) {
            // Remove previous selection
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('border-blue-500', 'bg-blue-50');
                option.classList.add('border-gray-200');
            });
            
            // Add selection to clicked option
            event.target.closest('.icon-option').classList.add('border-blue-500', 'bg-blue-50');
            event.target.closest('.icon-option').classList.remove('border-gray-200');
            
            selectedIcon = { name: iconName, emoji: iconEmoji };
            wizardData.icon = iconName;
            
            updateSummary();
            saveWizardData();
        }

        window.selectIconFromElement = function(element) {
            const iconName = element.getAttribute('data-icon');
            const iconEmoji = element.getAttribute('data-emoji');
            
            // Remove previous selection
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('border-blue-500', 'bg-blue-50');
                option.classList.add('border-gray-200');
            });
            
            // Add selection to clicked option
            element.classList.add('border-blue-500', 'bg-blue-50');
            element.classList.remove('border-gray-200');
            
            selectedIcon = { name: iconName, emoji: iconEmoji };
            wizardData.icon = iconName;
            
            updateSummary();
            saveWizardData();
        }

        window.setRadius = function(radius) {
            const slider = document.getElementById('radiusSlider');
            const value = document.getElementById('radiusValue');
            
            if (slider && value) {
                slider.value = radius;
                value.textContent = radius;
                wizardData.radius = radius;
                updateSummary();
            }
        }

        window.saveZone = function() {
            // Try to read current form values if they exist (for steps 0-2)
            // But don't rely on them if we're on step 3 (summary)
            if (currentStep < 3) {
                const nameInput = document.getElementById('zoneName');
                const addressInput = document.getElementById('zoneAddress');
                const radiusSlider = document.getElementById('radiusSlider');
                
                if (nameInput && nameInput.value.trim()) {
                    wizardData.name = nameInput.value.trim();
                }
                if (addressInput && addressInput.value.trim()) {
                    wizardData.address = addressInput.value.trim();
                }
                if (radiusSlider && radiusSlider.value) {
                    wizardData.radius = parseInt(radiusSlider.value) || 500;
                }
            }
            
            // Save current step data before validation
            saveCurrentStepData();
            
            if (!wizardData.name || !wizardData.name.trim()) {
                alert('Proszƒô wprowadziƒá nazwƒô strefy');
                return;
            }
            
            if (!wizardData.icon || wizardData.icon.trim() === '') {
                alert('Proszƒô wybraƒá ikonƒô strefy');
                return;
            }
            
            // Additional safety check - ensure selectedIcon is also set
            if (!selectedIcon || !selectedIcon.name) {
                if (wizardData.icon) {
                    selectedIcon = { name: wizardData.icon, emoji: getIconEmoji(wizardData.icon) };
                } else {
                    alert('B≈ÇƒÖd: Ikona nie zosta≈Ça wybrana');
                    return;
                }
            }
            
            if (!wizardData.address || !wizardData.address.trim()) {
                alert('Proszƒô wprowadziƒá adres strefy');
                return;
            }
            
            const formData = new FormData();
            formData.append('name', wizardData.name.trim());
            formData.append('icon', wizardData.icon);
            formData.append('address', wizardData.address.trim());
            formData.append('radius', wizardData.radius || 500);
            
            // Get selected devices from checkboxes if they exist
            const selectedDevices = document.querySelectorAll('input[type="checkbox"]:checked');
            selectedDevices.forEach(device => {
                formData.append('deviceIds', device.value);
            });
            
            // Also save device count to wizardData for summary
            wizardData.devicesCount = selectedDevices.length;
            wizardData.deviceIds = Array.from(selectedDevices).map(device => device.value);
            
            // Determine the correct endpoint and method
            const url = isEditMode ? `/zones/update/${existingZoneId}` : '/zones';
            const method = 'POST';
            
            fetch(url, {
                method: method,
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    localStorage.removeItem('wizardData');
                    window.location.href = response.url;
                } else {
                    alert(isEditMode ? 'WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji strefy' : 'WystƒÖpi≈Ç b≈ÇƒÖd podczas tworzenia strefy');
                }
            })
            .catch(error => {
                alert(isEditMode ? 'WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji strefy' : 'WystƒÖpi≈Ç b≈ÇƒÖd podczas tworzenia strefy');
            });
        }

        function validateCurrentStep() {
            // Only validate the current step's fields
            if (currentStep === 3) {
                // Step 3 (summary) - no validation needed, just return true
                return true;
            } else if (currentStep === 0) {
                // Step 0: Zone name and icon selection
                let zoneName = document.getElementById('zoneName');
                if (!zoneName) {
                    zoneName = document.querySelector('input[placeholder*="nazwƒô strefy"]');
                }
                if (!zoneName) {
                    zoneName = document.querySelector('input[type="text"]');
                }
                
                
                if (!zoneName || !zoneName.value.trim()) {
                    alert('Proszƒô wprowadziƒá nazwƒô strefy');
                    return false;
                }
                // Save the zone name
                wizardData.name = zoneName.value.trim();
                
                if (!selectedIcon || !selectedIcon.name || selectedIcon.name.includes('${')) {
                    alert('Proszƒô wybraƒá ikonƒô strefy');
                    return false;
                }
                
                // Save the icon
                wizardData.icon = selectedIcon.name;
            } else if (currentStep === 1) {
                // Step 1: Zone address
                const zoneAddress = document.getElementById('zoneAddress');
                if (!zoneAddress || !zoneAddress.value.trim()) {
                    alert('Proszƒô wprowadziƒá adres strefy');
                    return false;
                }
                // Save the zone address
                wizardData.address = zoneAddress.value.trim();
            } else if (currentStep === 2) {
                // Step 2: Radius (optional, has default value)
                const radiusSlider = document.getElementById('radiusSlider');
                if (radiusSlider) {
                    wizardData.radius = parseInt(radiusSlider.value) || 500;
                }
            }
            // Step 3 (summary) doesn't need validation
            
            return true;
        }

        function saveWizardData() {
            localStorage.setItem('wizardData', JSON.stringify(wizardData));
        }
        
        function saveCurrentStepData() {
            // Always try to save data from all visible form fields, regardless of current step
            // This ensures we capture any changes the user made
            
            // Step 0: Name and Icon (if visible)
            const nameInput = document.getElementById('zoneName');
            if (nameInput && nameInput.value.trim()) {
                wizardData.name = nameInput.value.trim();
            }
            
            // Step 1: Address (if visible)
            const addressInput = document.getElementById('zoneAddress');
            if (addressInput && addressInput.value.trim()) {
                wizardData.address = addressInput.value.trim();
            }
            
            // Step 2: Radius (if visible)
            const radiusSlider = document.getElementById('radiusSlider');
            if (radiusSlider && radiusSlider.value) {
                wizardData.radius = parseInt(radiusSlider.value) || 500;
            }
            
            // Icon is already saved when selected via selectIcon functions
        }
        
        function loadWizardData() {
            const saved = localStorage.getItem('wizardData');
            if (saved) {
                const savedData = JSON.parse(saved);
                
                // Preserve device data from database if it exists and saved data doesn't have devices
                if (wizardData.deviceIds && wizardData.deviceIds.length > 0 && (!savedData.deviceIds || savedData.deviceIds.length === 0)) {
                    savedData.deviceIds = wizardData.deviceIds;
                }
                
                // In edit mode, prioritize user changes (localStorage) over database data
                // Always use localStorage data if it exists (user changes)
                // Only fall back to database data if localStorage is empty
                if (savedData.icon && savedData.icon.trim() !== '') {
                    // Use saved icon data (user changes)
                } else if (wizardData.icon && wizardData.icon.trim() !== '') {
                    savedData.icon = wizardData.icon;
                }
                
                wizardData = { ...wizardData, ...savedData };
                
                // Always restore icon selection regardless of step (for edit mode)
                if (wizardData.icon) {
                    selectedIcon = { name: wizardData.icon, emoji: getIconEmoji(wizardData.icon) };
                }
                
                // Restore form fields based on current step
                if (currentStep === 0) {
                    // Step 0: Name and Icon
                    const zoneName = document.getElementById('zoneName');
                    if (zoneName && wizardData.name) {
                        zoneName.value = wizardData.name;
                        // Add event listener to save name changes immediately
                        zoneName.addEventListener('input', function() {
                            wizardData.name = this.value.trim();
                            saveWizardData();
                        });
                    }
                    
                    // Restore icon selection UI
                    if (wizardData.icon) {
                        document.querySelectorAll('.icon-option').forEach(option => {
                            option.classList.remove('border-blue-500', 'bg-blue-50');
                            option.classList.add('border-gray-200');
                        });
                        const selectedOption = document.querySelector(`[data-icon="${wizardData.icon}"]`);
                        if (selectedOption) {
                            selectedOption.classList.add('border-blue-500', 'bg-blue-50');
                            selectedOption.classList.remove('border-gray-200');
                        }
                    }
                } else if (currentStep === 1) {
                    // Step 1: Address
                    const zoneAddress = document.getElementById('zoneAddress');
                    if (zoneAddress && wizardData.address) {
                        zoneAddress.value = wizardData.address;
                        
                        // Add event listener to save address changes immediately
                        zoneAddress.addEventListener('input', function() {
                            wizardData.address = this.value.trim();
                            saveWizardData();
                        });
                    }
                } else if (currentStep === 2) {
                    // Step 2: Radius
                    const radiusSlider = document.getElementById('radiusSlider');
                    const radiusValue = document.getElementById('radiusValue');
                    if (radiusSlider && radiusValue && wizardData.radius) {
                        radiusSlider.value = wizardData.radius;
                        radiusValue.textContent = wizardData.radius;
                    }
                }
                
                // Always try to restore device selection if we have device data (regardless of current step)
                if (wizardData.deviceIds && wizardData.deviceIds.length > 0) {
                    // Only restore if we're not in edit mode (to avoid overriding database data)
                    if (!isEditMode) {
                        wizardData.deviceIds.forEach(deviceId => {
                            // Convert string to number for comparison with checkbox values
                            const deviceIdNum = parseInt(deviceId);
                            const deviceCheckbox = document.querySelector(`input[value="${deviceIdNum}"]`);
                            if (deviceCheckbox) {
                                deviceCheckbox.checked = true;
                            }
                        });
                    }
                }
                
                updateSummary();
            }
            
            
            // Attach event listeners after loading data
            attachFormEventListeners();
            
            // If we're on step 3, try to pre-select devices
            if (currentStep === 3) {
                preSelectDevices();
            }
        }

        function preSelectDevices() {
            if (wizardData.deviceIds && wizardData.deviceIds.length > 0) {
                // Check if checkboxes exist
                const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
                
                wizardData.deviceIds.forEach(deviceId => {
                    // Convert string to number for comparison with checkbox values
                    const deviceIdNum = parseInt(deviceId);
                    const deviceCheckbox = document.querySelector(`input[value="${deviceIdNum}"]`);
                    if (deviceCheckbox) {
                        deviceCheckbox.checked = true;
                    }
                });
            }
        }

        function updateSummary() {
            // Try to get current values from form fields if they exist
            const nameInput = document.getElementById('zoneName');
            const addressInput = document.getElementById('zoneAddress');
            const radiusSlider = document.getElementById('radiusSlider');
            
            if (nameInput && nameInput.value) {
                wizardData.name = nameInput.value;
            }
            if (addressInput && addressInput.value) {
                wizardData.address = addressInput.value;
            }
            if (radiusSlider && radiusSlider.value) {
                wizardData.radius = parseInt(radiusSlider.value);
            }
            
            // Update summary display
            const summaryName = document.getElementById('summaryName');
            const summaryIcon = document.getElementById('summaryIcon');
            const summaryAddress = document.getElementById('summaryAddress');
            const summaryRadius = document.getElementById('summaryRadius');
            const summaryNotifications = document.getElementById('summaryNotifications');
            
            if (summaryName) {
                summaryName.textContent = wizardData.name || '-';
            }
            if (summaryIcon) {
                // Map icon names to display names
                const iconDisplayNames = {
                    'home': 'üè† Dom',
                    'school': 'üè´ Szko≈Ça', 
                    'work': 'üè¢ Praca',
                    'hospital': 'üè• Szpital',
                    'gym': 'üí™ Si≈Çownia',
                    'park': 'üå≥ Park',
                    'shop': 'üõí Sklep',
                    'restaurant': 'üçΩÔ∏è Restauracja'
                };
                const iconDisplay = iconDisplayNames[wizardData.icon] || wizardData.icon || '-';
                summaryIcon.textContent = iconDisplay;
            }
            if (summaryAddress) {
                summaryAddress.textContent = wizardData.address || '-';
            }
            if (summaryRadius) {
                summaryRadius.textContent = (wizardData.radius || 500) + 'm';
            }
            
            const selectedDevices = document.querySelectorAll('input[type="checkbox"]:checked');
            const deviceCount = selectedDevices.length;
            
            // Update wizardData with device count
            wizardData.devicesCount = deviceCount;
            // Preserve deviceIds if nothing is checked yet (e.g., before preSelectDevices marks them)
            if (deviceCount > 0) {
                wizardData.deviceIds = Array.from(selectedDevices).map(device => device.value);
            }
            
            if (summaryNotifications) {
                summaryNotifications.textContent = deviceCount + ' urzƒÖdze≈Ñ';
            }
            
            // Save the updated data
            saveWizardData();
        }

            // Initialize wizard
            document.addEventListener('DOMContentLoaded', function() {
                // Get the actual step from the URL
                const urlParams = new URLSearchParams(window.location.search);
                const actualStep = parseInt(urlParams.get('step') || '0');
                currentStep = actualStep; // Update the global variable
                
                // On step 3 ensure pre-selection happens before summary reads selections
                if (currentStep === 3) {
                    preSelectDevices();
                    updateSummary();
                }
            
            const radiusSlider = document.getElementById('radiusSlider');
            const radiusValue = document.getElementById('radiusValue');
            
            if (radiusSlider && radiusValue) {
                radiusSlider.addEventListener('input', function() {
                    radiusValue.textContent = this.value;
                    wizardData.radius = parseInt(this.value);
                    updateSummary();
                    saveWizardData();
                });
            }
            
            const zoneName = document.getElementById('zoneName');
            if (zoneName) {
                zoneName.addEventListener('input', function() {
                    wizardData.name = this.value;
                    saveWizardData();
                });
            }
            
            const zoneAddress = document.getElementById('zoneAddress');
            if (zoneAddress) {
                zoneAddress.addEventListener('input', function() {
                    wizardData.address = this.value;
                    saveWizardData();
                });
            }
        });

        // Update summary on input changes
        document.addEventListener('input', function(e) {
            if (e.target.id === 'zoneName' || e.target.id === 'zoneAddress') {
                updateSummary();
            }
        });
        </script>
    </th:block>
</body>
</html>
